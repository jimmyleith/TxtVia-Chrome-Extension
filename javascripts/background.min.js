var TxtVia={};TxtVia.CHROME="Chrome";TxtVia.SAFARI="Safari";TxtVia.FIREFOX="FireFox";TxtVia.UNKNOWN="Unknown";TxtVia.init=function(){$.support.cors=true;$.ajaxSetup({cache:false,async:true,crossDomain:true,dataType:"json",timeout:4000});if(window.chrome){try{TxtVia.appID=chrome.i18n.getMessage("@@extension_id")}catch(a){console.error("[Chrome] Can't determand extension_id")}TxtVia.appName="Google Chrome";TxtVia.appType=TxtVia.CHROME}else{TxtVia.appID="0";TxtVia.appName="Unknown Client";TxtVia.appType=TxtVia.UNKNOWN}TxtVia.Pusher={};TxtVia.BeaconPush={};TxtVia.PushMethod="Pusher";switch(localStorage.env){case"development":TxtVia.url="http://localhost:8080";TxtVia.Pusher.webSocketID="c9351524b47769e60be7";TxtVia.BeaconPush.webSocketID="1adeccce";break;case"staging":TxtVia.url="http://staging.txtvia.com";TxtVia.Pusher.webSocketID="02364a48c5da78fd5244";TxtVia.BeaconPush.webSocketID="1adeccce";break;default:TxtVia.url="http://txtvia.com";TxtVia.Pusher.webSocketID="c0f2d772bdcdd2e04aa3";TxtVia.BeaconPush.webSocketID="1adeccce";break}TxtVia.Storage();TxtVia.WebDB.open();TxtVia.WebDB.createTables();if(TxtVia.uriParams("auth_token")){localStorage.authToken=TxtVia.uriParams("auth_token")}TxtVia.UNIQUE_ID=TxtVia.appType+":"+TxtVia.appID+":"+localStorage.authToken};TxtVia.uriParams=function(a){var b=new RegExp("[\\?&]"+a+"=([^&#]*)").exec(window.location.href);try{return b[1]||0}catch(c){return null}};TxtVia.TextUtil={};TxtVia.TextUtil.mobileNumber=function(c){try{var b=JSON.parse(localStorage.locale).country_calling;return c.replace(/\s/,"").replace(/^0/,b)}catch(a){console.log("[TxtVia.TextUtil.mobileNumber] can't convert number : "+c)}};TxtVia.WebDB={};TxtVia.WebDB.db=null;TxtVia.WebDB.open=function(){var a=5*1024*1024;TxtVia.WebDB.db=openDatabase("TxtVia","1.0","Browser based SMS client",a)};TxtVia.WebDB.onError=function(a,b){if(!b.CONSTRAINT_ERR){console.error(b);alert("Awe damn, Something went wrong: "+b.message+"\n\rIt would probly be a good idea contact support. \n\rhttp://txtvia.com/support")}};TxtVia.WebDB.onSuccess=function(a,b){};TxtVia.WebDB.createTables=function(){TxtVia.WebDB.db.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS messages (id INTEGER PRIMARY KEY ASC, message_id INTEGER UNIQUE NOT NULL, device_id INTEGER NOT NULL, client_id INTEGER, recipient TEXT NOT NULL, body TEXT NOT NULL, read INTEGER DEFAULT 0, messaged_at DATEIME NOT NULL, sent_at DATETIME, received_at DATETIME, created_at DATETIME)",[],function(b,c){console.log("[TxtVia.WebDB.createTables] messages created")},TxtVia.WebDB.onError);a.executeSql("CREATE TABLE IF NOT EXISTS devices (id INTEGER PRIMARY KEY ASC, name TEXT, device_type TEXT, unique_id TEXT UNIQUE NOT NULL, carrier TEXT)",[],function(b,c){console.log("[TxtVia.WebDB.createTables] devices created")},TxtVia.WebDB.onError);a.executeSql("CREATE TABLE IF NOT EXISTS contacts (name TEXT, number TEXT UNIQUE NOT NULL, photo_url TEXT)",[],function(b,c){console.log("[TxtVia.WebDB.createTables] contacts created")},TxtVia.WebDB.onError)})};TxtVia.WebDB.purge=function(a){localStorage.clear();TxtVia.WebDB.purgeDB(a)};TxtVia.WebDB.purgeDB=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("DROP TABLE devices",[],function(){console.log("[TxtVia.WebDB.purge] success")},function(c,d){console.error("[TxtVia.WebDB.purge] Failed");console.error(d)});b.executeSql("DROP TABLE messages",[],function(){console.log("[TxtVia.WebDB.purge] success")},function(c,d){console.error("[TxtVia.WebDB.purge] Failed");console.error(d)});b.executeSql("DROP TABLE contacts",[],function(){console.log("[TxtVia.WebDB.purge] success")},function(c,d){console.error("[TxtVia.WebDB.purge] Failed");console.error(d)})});if(a){TxtVia.WebDB.createTables()}};TxtVia.WebDB.insertInto={};TxtVia.WebDB.insertInto.messages=function(a,b){TxtVia.WebDB.db.transaction(function(c){console.log("[TxtVia.WebDB.insertInto.messages] accepted: ");console.log(a);c.executeSql("INSERT INTO messages (recipient, body, message_id, device_id, client_id, messaged_at, sent_at, received_at, created_at) VALUES (?,?,?,?,?,?,?,?,?)",[TxtVia.TextUtil.mobileNumber(a.recipient),a.body,a.id,a.device_id,a.client_id,a.messaged_at,a.sent_at,a.received_at,a.created_at],b,TxtVia.WebDB.onError)})};TxtVia.WebDB.insertInto.devices=function(a,b){TxtVia.WebDB.db.transaction(function(c){c.executeSql("INSERT INTO devices(name, device_type, carrier, unique_id) VALUES (?,?,?,?)",[a.name,a.device_type,a.carrier,a.unique_id],b,TxtVia.WebDB.onError)})};TxtVia.WebDB.insertInto.contacts=function(a,b){TxtVia.WebDB.db.transaction(function(c){c.executeSql("INSERT INTO contacts(name, number, photo_url) VALUES (?,?,?)",[a.name,TxtVia.TextUtil.mobileNumber(a.number),a.photo_url],b,TxtVia.WebDB.onError)})};TxtVia.WebDB.messageRead=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("UPDATE messages SET read = 1 WHERE id = ?",[a],null,TxtVia.WebDB.onError)})};TxtVia.WebDB.lastReceivedMessage=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("SELECT * FROM messages m LEFT JOIN contacts c On c.number = m.recipient ORDER BY id DESC LIMIT 1",[],a,TxtVia.WebDB.onError)})};TxtVia.WebDB.deletePendingMessage=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("DELETE FROM pending_messages WHERE id = ?",[a],null,TxtVia.WebDB.onError)})};TxtVia.WebDB.getConversations=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("SELECT * FROM messages m LEFT JOIN contacts c ON c.number = m.recipient GROUP BY m.recipient ORDER BY m.created_at DESC",[],function(c,d){var e;for(e=0;e<d.rows.length;e++){a(d.rows.item(e))}},TxtVia.WebDB.onError)})};TxtVia.WebDB.getContacts=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("SELECT * FROM contacts ORDER BY name DESC",[],function(c,d){var e,g=[],f;for(e=0;e<d.rows.length;e++){f={label:d.rows.item(e).name,value:d.rows.item(e).number,photo_url:d.rows.item(e).photo_url};g.push(f)}a(g)},TxtVia.WebDB.onError)})};TxtVia.WebDB.getMessages=function(a,b){TxtVia.WebDB.db.transaction(function(c){c.executeSql("SELECT * FROM `messages` m LEFT JOIN contacts c ON c.number = m.recipient WHERE m.`recipient` = ? ORDER BY `messaged_at` ASC",[a],b,TxtVia.WebDB.onError)})};TxtVia.WebDB.getContact=function(a,b){TxtVia.WebDB.db.transaction(function(c){c.executeSql("SELECT * FROM `contacts` WHERE number = ? LIMIT 1",[a],b,TxtVia.WebDB.onError)})};TxtVia.WebDB.getDevices=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("SELECT * FROM devices ORDER BY `name` ASC",[],a,TxtVia.WebDB.onError)})};TxtVia.WebDB.unReadMessageCount=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("SELECT COUNT(*) c FROM messages WHERE read = 0",[],a,TxtVia.WebDB.onError)})};TxtVia.Storage=function(){if(!localStorage.env){localStorage.env="production"}if(!localStorage.version){localStorage.version="1.0.3"}if(!localStorage.unReadMessages){localStorage.unReadMessages=0}if(!localStorage.firstLaunch){localStorage.firstLaunch=true}if(!localStorage.authToken){localStorage.authToken=""}if(!localStorage.googleToken){localStorage.googleToken=""}if(!localStorage.clientId){localStorage.clientId=0}if(!localStorage.pendingMessages){localStorage.pendingMessages=JSON.stringify([])}if(!localStorage.autoHideNotifications){localStorage.autoHideNotifications=true}if(!localStorage.enableSounds){localStorage.enableSounds=true}if(!localStorage.newMessageSound){localStorage.newMessageSound="newMessage.mp3"}if(!localStorage.locale){localStorage.locale=JSON.stringify({country_code:"GB",country_calling:"+44"})}};var Background={};Background.init=function(){TxtVia.init();Background.Update();if($.parseJSON(localStorage.clientId)===0){Background.Process.Post.client()}try{chrome.extension.onRequest.addListener(function(c,b,d){console.log("[Background.init.onRequest] Request received");if(c.sync){Background.Process.fullDownload(d)}else{if(c.client){Background.Process.Post.client()}else{if(c.updateBadge){Background.notify.icon()}else{if(c.googleToken){Background.Process.Get.googleToken(d)}else{console.log(c)}}}}})}catch(a){console.error("[Background.init] onRequest listener failed")}Background.notify.icon();Background.Process.Post.messages();Background.connection()};Background.isError=false;Background.Update=function(){var a=parseInt(localStorage.version.replace(/\./g,""),10);if(a<110){Background.Migrate.v110();localStorage.version="1.1.0";Background.Update();return}localStorage.version=chrome.app.getDetails().version};Background.Migrate={};Background.Migrate.v110=function(){localStorage.removeItem("messages");localStorage.removeItem("devices");localStorage.removeItem("contacts")};Background.Process={isError:false,completed:0,lock:false};Background.Process.Post={};Background.Process.Post.messagesTries=0;Background.Process.Post.messages=function(){var a=$.parseJSON(localStorage.pendingMessages);if(a.length>0&&window.navigator.onLine&&localStorage.authToken){console.log("[Background.Process.message] preparing to send message");$.ajax({url:TxtVia.url+"/messages.json",type:"POST",data:a[0].data+"&sent_at="+encodeURIComponent(new Date())+"&client_id="+localStorage.clientId+"&auth_token="+localStorage.authToken,success:function(b){Background.Process.Post.messagesTries=0;console.log("[Background.Process.message] message sent");Background.Process.isError=false;Background.notify.message.sent(b);TxtVia.WebDB.insertInto.messages(b,function(){chrome.extension.sendRequest({message:b},function(){console.log("[Background.Process.Post.messages] sent to display")})});a.shift();localStorage.pendingMessages=JSON.stringify(a);localStorage.pendingMessages=JSON.stringify(a)},error:function(b){console.error(b);if(Background.Process.isError===false&&(b.status===422&&$.parseJSON(b.responseText).client)){Background.Process.Post.client(function(){Background.Process.isError=false});Background.Process.isError=true}else{Background.Process.Post.messagesTries=Background.Process.Post.messagesTries+1;if(Background.Process.isError===false){Background.notify.message.failed(a[0]);Background.Process.isError=true}if(Background.Process.Post.messagesTries>=5){Background.notify.message.skipped(a[0]);a.shift();localStorage.pendingMessages=JSON.stringify(a);localStorage.pendingMessages=JSON.stringify(a);Background.Process.isError=false}}},complete:function(){setTimeout(Background.Process.Post.messages,100)}})}else{setTimeout(Background.Process.Post.messages,100)}};Background.Process.Post.client=function(a){if(Background.Process.lock===false){$.ajax({url:TxtVia.url+"/devices.json",type:"POST",data:"unique_id="+TxtVia.UNIQUE_ID+"&type=client&name="+encodeURIComponent(TxtVia.appName)+"&auth_token="+localStorage.authToken,beforeSent:function(){Background.Process.lock=true},success:function(b){localStorage.clientId=b.id;Background.notify.client.success(b)},error:function(d,c,b){if(d.status===422){Background.Process.Get.device()}else{console.error("[Background.Process.Post.client] failed : "+d.responseText);Background.notify.client.failed()}},complete:function(){Background.Process.lock=false;if(a){a()}}})}};Background.Process.Get={};Background.Process.Get.googleToken=function(a){if(Background.Process.lock===false){$.ajax({url:TxtVia.url+"/contacts/token.json?auth_token="+localStorage.authToken,type:"GET",beforeSend:function(){Background.Process.lock=true},success:function(b){localStorage.googleToken=b.get_token;a(b.get_token)},error:function(b){console.error("[Background.Process.Get.googleToken] failed : "+b.responseText)},complete:function(){Background.Process.lock=false}})}};Background.Process.Get.contacts=function(){$.ajax({url:TxtVia.url+"/contacts.json?auth_token="+localStorage.authToken,type:"GET",success:function(a){if(a){$.each(a,function(){var b={name:this.label,number:this.value,photo_url:this.avatar};TxtVia.WebDB.insertInto.contacts(b,null)})}Background.Process.completed=Background.Process.completed+1},error:function(a){console.error("[Background.Process.Get.contacts] failed : "+a.responseText)}})};Background.Process.Get.messages=function(){$.ajax({url:TxtVia.url+"/messages.json?auth_token="+localStorage.authToken,type:"GET",success:function(a){$.each(a.devices,function(){TxtVia.WebDB.insertInto.devices(this)});$.each(a.messages,function(){TxtVia.WebDB.insertInto.messages(this)});Background.Process.completed=Background.Process.completed+1},error:function(a){console.error("[Background.Process.Get.messages] failed : "+a.responseText);if(a.status===401){localStorage.authToken=""}}})};Background.Process.Get.device=function(){$.ajax({url:TxtVia.url+"/devices/"+TxtVia.UNIQUE_ID+".json",type:"GET",success:function(a){localStorage.clientId=a.id;Background.notify.client.restored(a)},error:function(a){console.error("[Background.Process.Get.device] failed : "+a.responseText)}})};Background.Process.fullDownload=function(a){Background.Process.completed=0;Background.Process.Get.contacts();Background.Process.Get.messages();Background.Process.onDevices()};Background.Process.onDevices=function(){if(Background.Process.completed>=2){TxtVia.WebDB.getDevices(function(b,c){if(c.rows.length>0){Background.notify.syncComplete()}});try{callback()}catch(a){}Background.Process.completed=0}else{setTimeout(Background.Process.onDevices,500)}};Background.notify={};Background.notify.icon=function(){TxtVia.WebDB.unReadMessageCount(function(a,c){var b=c.rows.item(0).c;chrome.browserAction.setBadgeText({text:b>0?b.toString():""})})};Background.notify.newMessage=function(a){var b=webkitNotifications.createNotification(chrome.extension.getURL("/images/newMessage.png"),"New message from "+a.name,a.body);b.ondisplay=function(){var c;if($.parseJSON(localStorage.enableSounds)){c=new Audio(chrome.extension.getURL(localStorage.newMessageSound));c.play()}if($.parseJSON(localStorage.autoHideNotifications)){setTimeout(function(){b.cancel()},10000)}};b.onclick=function(){chrome.tabs.create({url:chrome.extension.getURL("popup.html")});b.cancel()};b.show();chrome.extension.sendRequest({message:a},function(){console.log("[Background.notify.newMessage] message sent to PopUp")});Background.notify.icon()};Background.notify.client={};Background.notify.client.success=function(a){var b=webkitNotifications.createNotification(chrome.extension.getURL("/images/complete.png"),"Congradulations","You have successfully setup "+a.name+" with TxtVia.");b.ondisplay=function(){var c;if($.parseJSON(localStorage.enableSounds)){c=new Audio(chrome.extension.getURL("done.mp3"));c.play()}if($.parseJSON(localStorage.autoHideNotifications)){setTimeout(function(){b.cancel()},10000)}};b.onclick=function(){b.cancel()};b.show()};Background.notify.client.restored=function(a){var b=webkitNotifications.createNotification(chrome.extension.getURL("/images/synced.png"),"Welcome Back","You have successfully restored TxtVia for "+a.name);b.ondisplay=function(){var c;if($.parseJSON(localStorage.enableSounds)){c=new Audio(chrome.extension.getURL("done.mp3"));c.play()}if($.parseJSON(localStorage.autoHideNotifications)){setTimeout(function(){b.cancel()},10000)}};b.onclick=function(){b.cancel()};b.show()};Background.notify.client.failed=function(a){var d,b,c;switch(a){case 401:c=function(){chrome.tabs.create({url:TxtVia.url+"/sign_in?return_url="+encodeURIComponent(chrome.extension.getURL("/popup.html"))})};b="Failed to successfully login to TxtVia. \n\rClick here re-authenticate.";break;case 500:b="Oh my gosh, TxtVia is having a major hickup right now. ";break;default:c=function(){Background.Process.Post.client()};b="Failed to successfully setup device with TxtVia.\n\r Click here to try again.";break}d=webkitNotifications.createNotification(chrome.extension.getURL("/images/failed.png"),"Awe damn",b);d.onclick=function(){c();d.cancel()};console.log(d);d.show()};Background.notify.message={};Background.notify.message.sent=function(a){var b=webkitNotifications.createNotification(chrome.extension.getURL("/images/messageSent.png"),"Sent Message","Your message is on it's way to "+a.recipient);b.ondisplay=function(){if($.parseJSON(localStorage.autoHideNotifications)){setTimeout(function(){b.cancel()},5000)}};b.onclick=function(){b.cancel()};b.show()};Background.notify.message.failed=function(a){var b=webkitNotifications.createNotification(chrome.extension.getURL("/images/messageFailed.png"),"Awe damn","Failed to successfully send a message. \nDon't worry, the message will be delivered soon.");b.ondisplay=function(){if($.parseJSON(localStorage.autoHideNotifications)){setTimeout(function(){b.cancel()},5000)}};b.onclick=function(){b.cancel()};b.show()};Background.notify.message.skipped=function(a){var b=webkitNotifications.createNotification(chrome.extension.getURL("/images/messageFailed.png"),"Awe damn","A messsage has failed to be processed. \n\rThis message is being skipped.");b.onclick=function(){b.cancel()};b.show()};Background.notify.syncComplete=function(a){var b=webkitNotifications.createNotification(chrome.extension.getURL("/images/messageSyncComplete.png"),"Woohooo","Your messages and contacts are now synced.");b.ondisplay=function(){if($.parseJSON(localStorage.autoHideNotifications)){setTimeout(function(){b.cancel()},5000)}};b.onclick=function(){b.cancel()};b.show()};Background.connection=function(){if(!TxtVia.server&&window.navigator.onLine){Pusher.channel_auth_endpoint=TxtVia.url+"/users/auth/client/?auth_token="+localStorage.authToken;switch(TxtVia.PushMethod){case"Pusher":console.log("[Background.connection] Using Pusher");TxtVia.server=new Pusher(TxtVia.Pusher.webSocketID.toString());TxtVia.channel=TxtVia.server.subscribe("txtvia_"+localStorage.authToken);TxtVia.channel.bind("subscription_error",function(a){console.error("[WebSocket] gave status code : "+a);if(a===401){Background.notify.client.failed(a)}});TxtVia.server.connection.bind("connected",function(){console.log("[WebSocket] Connected")});TxtVia.channel.bind("message",function(b){try{if(b){TxtVia.WebDB.insertInto.messages(b);TxtVia.WebDB.getMessages(b.recipient,function(c,d){b.name=d.rows.item(0).name;Background.notify.newMessage(b)})}}catch(a){console.error("[WebSocket] Failed to parse message data.");console.error(a)}});TxtVia.channel.bind("device",function(b){try{if(b){console.log(b);TxtVia.WebDB.insertInto.devices(b);Background.notify.client.success(b)}}catch(a){console.error("[WebSocket] Failed to parse device data.");console.error(a)}});break;case"BeaconPush":console.log("[Background.connection] Using BeaconPush");Beacon.connect(TxtVia.BeaconPush.webSocketID,["txtvia"],{log:localStorage.env==="development"?true:false,user:localStorage.authToken});Beacon.listen(function(d){console.log(d);var c,b;try{if(d.message){c=$.parseJSON(d.message);console.log(c);TxtVia.WebDB.insertInto.messages(c,function(){console.log("insterted message")});TxtVia.WebDB.getMessages(c.recipient,function(e,f){c.name=f.rows.item(0).name});Background.notify.newMessage(c)}else{if(d.device){b=$.parseJSON(d.device);Background.notify.client.success(b);TxtVia.WebDB.insertInto.devices(b)}}}catch(a){console.error("[WebSocket] Failed to parse Beacon Push data.");console.error(a)}});break;default:TxtVia.PushMethod="Pusher";Background.connection();break}return TxtVia.server}else{setTimeout(Background.connection,1000);return TxtVia.server}};Background.init();