/*globals $,chrome,localStorage,console,window,setTimeout,setInterval,clearTimeout */

var TxtVia = {};

// App Types
TxtVia.CHROME = "Chrome";
TxtVia.SAFARI = "Safari";
TxtVia.FIREFOX = "FireFox";
TxtVia.UNKNOWN = "Unknown";
TxtVia.init = function () {
    $.support.cors = true;
    $.ajaxSetup({
        cache: false,
        async: true,
        crossDomain: true,
        dataType: "json",
        timeout: 4000
    });
    if (window.chrome) {
        try {
            TxtVia.appID = chrome.i18n.getMessage("@@extension_id");
        } catch (eer) {
            console.error("[Chrome] Can't determand extension_id");
        }
        TxtVia.appName = "Google Chrome";
        TxtVia.appType = TxtVia.CHROME;
    } else {
        TxtVia.appID = "0";
        TxtVia.appName = "Unknown Client";
        TxtVia.appType = TxtVia.UNKNOWN;
    }
    TxtVia.Pusher = {};
    TxtVia.BeaconPush = {};
    TxtVia.PushMethod = "Pusher";
    switch (localStorage.env) {
    case "development":
        TxtVia.url = "http://localhost:8080";
        TxtVia.Pusher.webSocketID = "c9351524b47769e60be7";
        TxtVia.BeaconPush.webSocketID = "1adeccce";
        break;
    case "staging":
        TxtVia.url = "http://staging.txtvia.com";
        TxtVia.Pusher.webSocketID = "02364a48c5da78fd5244";
        TxtVia.BeaconPush.webSocketID = "1adeccce";
        break;
    default:
        TxtVia.url = "http://txtvia.com";
        TxtVia.Pusher.webSocketID = "c0f2d772bdcdd2e04aa3";
        TxtVia.BeaconPush.webSocketID = "1adeccce";
        break;
    }



    TxtVia.Storage();
    TxtVia.WebDB.open();
    TxtVia.WebDB.createTables();
    if (TxtVia.uriParams('auth_token')) {
        localStorage.authToken = TxtVia.uriParams('auth_token');
    }
    TxtVia.UNIQUE_ID = TxtVia.appType + ":" + TxtVia.appID + ":" + localStorage.authToken;
};
TxtVia.uriParams = function (name) {
    var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.href);
    try {
        return results[1] || 0;
    } catch (err) {
        return null;
    }
};
TxtVia.TextUtil = {};
TxtVia.TextUtil.mobileNumber = function (number) {
    var code = JSON.parse(localStorage.locale).country_calling;
    return number.replace(/\s/, '').replace(/^0/, code);
};
/**
 * @depend txtvia.js
 **/
/*globals $, TxtVia, openDatabase,localStorage,console,alert,window,setTimeout,setInterval,clearTimeout */
TxtVia.WebDB = {};
TxtVia.WebDB.db = null;
TxtVia.WebDB.open = function () {
    var dbSize = 5 * 1024 * 1024;
    TxtVia.WebDB.db = openDatabase("TxtVia", "1.0", "Browser based SMS client", dbSize);
};
TxtVia.WebDB.onError = function (tx, e) {
    if (!e.CONSTRAINT_ERR) {
        console.error(e);
        alert("Awe damn, Something went wrong: " + e.message + "\n\rIt would probly be a good idea contact support. \n\rhttp://txtvia.com/support");
    }
};
TxtVia.WebDB.onSuccess = function (tx, r) {
    // :todo  
};
TxtVia.WebDB.createTables = function () {
    TxtVia.WebDB.db.transaction(function (tx) {
        // tx.executeSql('CREATE TABLE IF NOT EXISTS pending_messages (id INTEGER PRIMARY KEY ASC, ' +
        //                 'recipient TEXT, ' +
        //                 'body TEXT, ' +
        //                 'sent_at DATETIME)', [], function(){
        //                     console.log('[TxtVia.WebDB.createTables] pending_messages created');
        //                 }, TxtVia.WebDB.onError);
        tx.executeSql('CREATE TABLE IF NOT EXISTS messages (id INTEGER PRIMARY KEY ASC, message_id INTEGER UNIQUE NOT NULL, device_id INTEGER NOT NULL, client_id INTEGER, recipient TEXT NOT NULL, body TEXT NOT NULL, read INTEGER DEFAULT 0, messaged_at DATEIME NOT NULL, sent_at DATETIME, received_at DATETIME, created_at DATETIME)', [], function (tx, r) {
            console.log('[TxtVia.WebDB.createTables] messages created');
        }, TxtVia.WebDB.onError);
        tx.executeSql('CREATE TABLE IF NOT EXISTS devices (id INTEGER PRIMARY KEY ASC, name TEXT, device_type TEXT, unique_id TEXT UNIQUE NOT NULL, carrier TEXT)', [], function (tx, r) {
            console.log('[TxtVia.WebDB.createTables] devices created');
        }, TxtVia.WebDB.onError);
        tx.executeSql('CREATE TABLE IF NOT EXISTS contacts (name TEXT, number TEXT UNIQUE NOT NULL, photo_url TEXT)', [], function (tx, r) {
            console.log('[TxtVia.WebDB.createTables] contacts created');
        }, TxtVia.WebDB.onError);
    });
};
TxtVia.WebDB.purge = function (createTables) {
    localStorage.clear();
    TxtVia.WebDB.db.transaction(function (tx) {
        tx.executeSql('DROP TABLE devices', [], function () {
            console.log("[TxtVia.WebDB.purge] success");
        }, function (tx, e) {
            console.error("[TxtVia.WebDB.purge] Failed");
            console.error(e);
        });
        tx.executeSql('DROP TABLE messages', [], function () {
            console.log("[TxtVia.WebDB.purge] success");
        }, function (tx, e) {
            console.error("[TxtVia.WebDB.purge] Failed");
            console.error(e);
        });
        tx.executeSql('DROP TABLE contacts', [], function () {
            console.log("[TxtVia.WebDB.purge] success");
        }, function (tx, e) {
            console.error("[TxtVia.WebDB.purge] Failed");
            console.error(e);
        });
    });
    if (createTables) {
        TxtVia.WebDB.createTables();
    }
};
TxtVia.WebDB.insertInto = {};
TxtVia.WebDB.insertInto.messages = function (message, callback) {
    TxtVia.WebDB.db.transaction(function (tx) {
        tx.executeSql('INSERT INTO messages(recipient, body, message_id, device_id, client_id, messaged_at, sent_at, received_at, created_at) VALUES (?,?,?,?,?,?,?,?,?)', [TxtVia.TextUtil.mobileNumber(message.recipient), message.body, message.id, message.device_id, message.client_id, message.messaged_at, message.sent_at, message.received_at, message.created_at], callback, TxtVia.WebDB.onError);
    });
};
TxtVia.WebDB.insertInto.devices = function (device, callback) {
    TxtVia.WebDB.db.transaction(function (tx) {
        tx.executeSql('INSERT INTO devices(name, device_type, carrier, unique_id) VALUES (?,?,?,?)', [device.name, device.device_type, device.carrier, device.unique_id], callback, TxtVia.WebDB.onError);
    });
};
TxtVia.WebDB.insertInto.contacts = function (contact, callback) {
    TxtVia.WebDB.db.transaction(function (tx) {
        tx.executeSql('INSERT INTO contacts(name, number, photo_url) VALUES (?,?,?)', [contact.name, TxtVia.TextUtil.mobileNumber(contact.number), contact.photo_url], callback, TxtVia.WebDB.onError);
    });
};
TxtVia.WebDB.messageRead = function (id) {
    TxtVia.WebDB.db.transaction(function (tx) {
        tx.executeSql('UPDATE messages SET read = 1 WHERE id = ?', [id], null, TxtVia.WebDB.onError);
    });
};
TxtVia.WebDB.lastReceivedMessage = function (callback) {
    TxtVia.WebDB.db.transaction(function (tx) {
        tx.executeSql("SELECT * FROM messages m LEFT JOIN contacts c On c.number = m.recipient ORDER BY id DESC LIMIT 1", [], callback, TxtVia.WebDB.onError);
    });
};
TxtVia.WebDB.deletePendingMessage = function (id) {
    TxtVia.WebDB.db.transaction(function (tx) {
        tx.executeSql('DELETE FROM pending_messages WHERE id = ?', [id], null, TxtVia.WebDB.onError);
    });
};

TxtVia.WebDB.getConversations = function (callback) {
    TxtVia.WebDB.db.transaction(function (tx) {
        tx.executeSql('SELECT * FROM messages m LEFT JOIN contacts c ON c.number = m.recipient GROUP BY m.recipient ORDER BY m.created_at DESC', [], function (tx, rs) {
            var i;
            for (i = 0; i < rs.rows.length; i++) {
                callback(rs.rows.item(i));
            }
        }, TxtVia.WebDB.onError);
    });
};
TxtVia.WebDB.getContacts = function (callback) {
    TxtVia.WebDB.db.transaction(function (tx) {
        tx.executeSql('SELECT * FROM contacts ORDER BY name DESC', [], function (tx, rs) {
            var i, array = [],
                hash;
            for (i = 0; i < rs.rows.length; i++) {
                hash = {
                    label: rs.rows.item(i).name,
                    value: rs.rows.item(i).number
                };
                array.push(hash);
            }
            callback(array);
        }, TxtVia.WebDB.onError);
    });
};
TxtVia.WebDB.getMessages = function (recipient, callback) {
    TxtVia.WebDB.db.transaction(function (tx) {
        tx.executeSql('SELECT * FROM `messages` m LEFT JOIN contacts c ON c.number = m.recipient WHERE m.`recipient` = ? ORDER BY `messaged_at` ASC', [recipient], callback, TxtVia.WebDB.onError);
    });
};
TxtVia.WebDB.getContact = function (number, callback) {
    TxtVia.WebDB.db.transaction(function (tx) {
        tx.executeSql('SELECT * FROM `contacts` WHERE number = ? LIMIT 1', [number], callback, TxtVia.WebDB.onError);
    });
};
TxtVia.WebDB.getDevices = function (callback) {
    TxtVia.WebDB.db.transaction(function (tx) {
        tx.executeSql('SELECT * FROM devices ORDER BY `name` ASC', [], callback, TxtVia.WebDB.onError);
    });
};
TxtVia.WebDB.unReadMessageCount = function (callback) {
    TxtVia.WebDB.db.transaction(function (tx) {
        tx.executeSql("SELECT COUNT(*) c FROM messages WHERE read = 0", [], callback, TxtVia.WebDB.onError);
    });
};
TxtVia.Storage = function () {
    if (!localStorage.env){
        localStorage.env = "production";
    }
    if (!localStorage.unReadMessages) {
        localStorage.unReadMessages = 0;
    }
    if (!localStorage.firstLaunch) {
        localStorage.firstLaunch = true;
    }
    if (!localStorage.authToken) {
        localStorage.authToken = "";
    }
    if (!localStorage.googleToken) {
        localStorage.googleToken = "";
    }
    if (!localStorage.clientId) {
        localStorage.clientId = 0;
    }
    if (!localStorage.pendingMessages) {
        localStorage.pendingMessages = JSON.stringify([]);
    }
    if (!localStorage.autoHideNotifications) {
        localStorage.autoHideNotifications = true;
    }
    if (!localStorage.enableSounds) {
        localStorage.enableSounds = true;
    }
    if (!localStorage.newMessageSound) {
        localStorage.newMessageSound = 'newMessage.mp3';
    }
    if (!localStorage.locale) {
        localStorage.locale = JSON.stringify({
            country_code: 'GB',
            country_calling: '+44'
        });
    }
};

/*globals $, TxtVia, chrome,localStorage,console,alert,window,setTimeout,setInterval,clearTimeout */

/**
 * @depend storage.js
 **/
var PopUp = (function () {
    return {
        init: function () {
            TxtVia.init();
            PopUp.Check.firstLaunch(function () {
                PopUp.Check.authToken(function () {
                    PopUp.Check.client(function () {
                        PopUp.Check.devices();
                    });
                });
            });

            $(window).load(function () {
                $("body").addClass("loaded");
            });

            PopUp.RegisterEvents.submitForm();
            PopUp.RegisterEvents.display();
            PopUp.RegisterEvents.validateForm();

            // PopUp.Process.view();
            $("form#security").submit(function (e) {
                e.preventDefault();
            });
            $("input[type=search]").focus(function () {
                $(this).val("");
            });
            $("input[type=password][name=pincode]").bind("keyup", function (e) {
                if (parseInt($(this).val(), 10) === 1234) {
                    $(this).val("");
                    PopUp.Actions.unlock();
                }
            });

            try {
                chrome.extension.onRequest.addListener(function (request, sender, callback) {
                    if (request.message) {
                        if (PopUp.currentThread === TxtVia.TextUtil.mobileNumber(request.message.recipient)) {
                            PopUp.Process.threadConversation(request.message.recipient);
                        }
                        PopUp.Process.threads();
                    } else {
                        console.log(request);
                    }
                });
            } catch (e) {
                console.error("[Background.init] onRequest listener failed");

            }

        },
        Check: {
            tries: 0,
            firstLaunch: function (callback) {
                if ($.parseJSON(localStorage.firstLaunch) === true) {
                    localStorage.firstLaunch = false;
                    console.log('[PopUp.Init] First Launch');
                    $("body").addClass("firstLaunch").removeClass("unlocked main steps");
                    setTimeout(callback, 2000);
                } else {
                    callback();
                    console.log('[PopUp.Init] Normal Launch');
                    $("body").removeClass('firstLaunch');
                }
            },
            authToken: function (callback) {
                if (localStorage.authToken === "") {
                    console.log('[PopUp.Init] No Auth Token');
                    $("body").removeClass('main unlocked').addClass('locked').addClass("steps");
                } else {
                    console.log('[PopUp.Init] Auth Token');
                    $("body").addClass("unlocked").removeClass("locked");
                    callback();
                }
            },
            client: function (callback) {
                if ($.parseJSON(localStorage.clientId) !== 0) {
                    console.log('[PopUp.Init] Client not registered');
                    $("body").removeClass('main');
                    $(".steps ol li:eq(0)").removeClass("done");
                } else {
                    console.log('[PopUp.Init] Client registered');
                    $(".steps ol li:eq(0)").addClass("done");
                    callback();
                }
            },
            devices: function () {
                if (PopUp.Check.tries < 5) {
                    TxtVia.WebDB.getDevices(function (t, r) {
                        if (r.rows.length === 0) {
                            console.log('[PopUp.Init] No devices');
                            chrome.extension.sendRequest({
                                sync: true
                            }, function () {
                                PopUp.Check.devices();
                            });
                            $("body").removeClass('main').addClass("steps");
                        } else {
                            console.log('[PopUp.Init] ' + r.rows.length + ' devices registered');
                            PopUp.Process.view();
                            $("body").addClass("main").removeClass('steps');
                            $(".steps ol li:eq(0)").addClass("done");
                        }
                    });
                } else {
                    console.log("[PopUp.Check.devices] exceeded max tries.");
                }
            }
        },
        Process: {
            view: function () {
                console.log("Rendering View");
                PopUp.UI.deviceList();
                PopUp.Process.threads();
                PopUp.Process.contacts();
                $("form").removeClass("loading");
            },
            contacts: function () {
                TxtVia.WebDB.getContacts(function (data) {
                    $("input[type=search]").autocomplete({
                        source: data,
                        select: function (e, ui) {
                            var conversation = {
                                recipient: ui.item.value,
                                name: ui.item.label
                            };
                            e.preventDefault();
                            $("body").removeClass("threads").addClass("thread");
                            $("input[type=search]").val(ui.item.label).blur();
                            $("form#new_message textarea").focus();
                            $("form input[name=recipient]").val(ui.item.value);

                            PopUp.Process.thread(conversation, ui.item.value);
                        }
                    });
                });
            },
            threads: function () {
                console.log("Rendering Threads");
                $("#threads ul li:not(.new_message)").remove();
                TxtVia.WebDB.getConversations(function (message) {
                    console.log(message);
                    var li = $("<li>", {
                        'class': 'clearfix'
                    }),
                        avatar = message.photo_url ? message.photo_url + "?access_token=" + localStorage.googleToken : chrome.extension.getURL('/images/user_profile_image50.png'),
                    //Contact.lookup(message.recipient).avatar ? Contact.lookup(message.recipient).avatar: '/images/user_profile_image50.png',
                    img = $("<img>", {
                        'class': 'avatar',
                        src: avatar
                    }).hide().data('photo_url', message.photo_url),
                        h3 = $("<h3>", {
                        html: message.name ? message.name : message.recipient
                    }),
                        p = $("<p>", {
                        text: message.body
                    });
                    img.error(function () {
                        PopUp.Actions.updateGoogleToken();
                        $(this).attr('src', chrome.extension.getURL('/images/user_profile_image50.png'));
                    }).bind('load', function () {
                        $(this).fadeIn();
                    });
                    li.append(img).append(h3).append(p);
                    li.bind("click", function () {
                        console.log("Opening Thread " + message.recipient);
                        PopUp.Process.thread(message, PopUp.Actions.gotToThread);
                        // PopUp.Actions.gotToThread();
                    });
                    $("#threads ul").append(li);
                });
            },
            thread: function (conversation, callback) {
                console.log(conversation);
                PopUp.currentThread = conversation.recipient;
                var header = $("<h3>", {
                    text: conversation.name ? conversation.name : conversation.recipient
                }),
                    avatar = conversation.photo_url ? conversation.photo_url + "?access_token=" + localStorage.googleToken : chrome.extension.getURL('/images/user_profile_image30.png'),
                    img = $("<img>", {
                    'class': 'avatar',
                    src: avatar
                }).hide().data('photo_url', conversation.photo_url);
                img.bind('load', function () {
                    $(this).fadeIn();
                }).error(function () {
                    PopUp.Actions.updateGoogleToken();
                    $(this).attr('src', chrome.extension.getURL('/images/user_profile_image30.png'));
                });
                $(".thread header hgroup").empty().append(img).append(header);
                $("form input[name=recipient]").val(conversation.recipient);

                PopUp.Process.threadConversation(conversation.recipient);


                if (callback) {
                    callback();
                }
            },
            threadConversation: function (recipient) {
                $(".thread ol").empty();
                TxtVia.WebDB.getMessages(recipient, function (t, r) {
                    var i;
                    for (i = 0; i < r.rows.length; i++) {

                        var message = r.rows.item(i),
                            li = $("<li>", {
                            'class': message.sent_at ? "sent" : "received",
                            html: message.body + "&nbsp;"
                        }),
                            time = $("<time>", {
                            datetime: $.timeago(message.messaged_at),
                            html: $.timeago(message.messaged_at)
                        });
                        TxtVia.WebDB.messageRead(message.id);
                        li.append(time);
                        time.timeago();
                        $(".thread ol").append(li);
                    }
                    $(".thread .scroll").animate({
                        scrollTop: $(".thread .scroll .messages").height()
                    });
                    chrome.extension.sendRequest({
                        updateBadge: true
                    }, function () {
                        console.log("[Background.Process.threadConversation] comeplete");
                    });
                });
            }
        },
        RegisterEvents: {
            display: function () {
                var login = $("<a>", {
                    href: "#",
                    'class':'login',
                    text: "Login",
                    click: function () {
                        PopUp.Actions.loginLink();
                    }
                }),
                    logout = $("<a>", {
                    href: "#",
                    'class':'logout',
                    text: "Logout",
                    click: function () {
                        PopUp.Actions.logoutLink();
                    }
                }),
                    hr = $("<hr>"),
                    sync = $("<a>", {
                    href: "#",
                    'class':'sync',
                    text: "Sync",
                    click: function () {
                        PopUp.Actions.syncLink();
                    }
                }),
                    donate = $("<a>", {
                    href: 'http://txtvia.com/donate_now',
                    'class':'donate',
                    text: "Donate",
                    click: function () {
                        PopUp.Actions.donateLink();
                    }
                });
                $("header nav").empty().append(sync).append(donate).append(hr);
                if (localStorage.authToken !== "") {
                    $("header nav").append(logout);
                } else {
                    $("header nav").append(login);
                }

                $("a.showSettings").bind("click", function () {
                    $(".settings:not(:visible)").fadeIn();
                });
                $(".settings a").click(function () {
                    $(".settings:visible").fadeOut();
                });
                $(".settings").bind("mouseleave", function () {
                    if (window.settingTimeout) {
                        clearTimeout(window.settingTimeout);
                    }
                    window.settingTimeout = setTimeout(function () {
                        $(".settings:visible").fadeOut();
                    }, 3000);
                });

            },

            validateForm: function () {
                $("textarea").bind("keyup", function () {
                    if ($(this).val() === "") {
                        $("form#new_message").find("input[type=submit]").attr("disabled", "disabled");
                    } else {
                        $("form#new_message").find("input[type=submit]").removeAttr("disabled");

                    }
                });
            },
            submitForm: function () {
                $("form#new_message textarea").keydown(function (e) {
                    // alert(e.keyCode);
                    if ((e.ctrlKey || e.metaKey) && e.keyCode === 13) {
                        $("form#new_message").trigger('submit');
                    }
                });

                $("form#new_message").bind("submit", function (e) {
                    var self = $(this);
                    if ($("form#new_message textarea").val().length > 0) {

                        $("form#new_message").addClass("loading");
                        $(":input[name=device_id]").val($(":input[name=device]").val());
                        // append message to pendingQueue
                        var pendingMessages = $.parseJSON(localStorage.pendingMessages),
                            item = {
                            "data": $(this).serialize()
                        },
                            body_p = $("<p>", {
                            text: $(this).find(":input[name='body']").val()
                        }),
                            header = $("<header>", {
                            text: $(this).find(":input[name='recipient']").val()
                        }),
                            article = $("<article>").append(header).append(body_p);

                        $("#sent .messages").append(article);


                        var li = $("<li>", {
                            'class': "sent sending",
                            html: self.find("textarea").val() + "&nbsp;"
                        }),
                            time = $("<time>", {
                            html: "sending&hellip;"
                        });
                        li.append(time);
                        $(".thread ol").append(li);
                        $(".thread .scroll").animate({
                            scrollTop: $(".thread .scroll").height()
                        });
                        pendingMessages.push(item);
                        localStorage.pendingMessages = JSON.stringify(pendingMessages);
                        $(this).find("textarea").val("");
                    }
                    e.preventDefault();
                });
            }
        },
        Actions: {
            loginLink: function () {
                if (chrome.tabs) {
                    chrome.tabs.create({
                        url: TxtVia.url + '/sign_in?return_url=' + encodeURIComponent(chrome.extension.getURL("/popup.html"))
                    });
                } else {
                    window.open(TxtVia.url + '/sign_in?return_url=' + window.location.href);
                }
                window.close();
                // url:TxtVia.url + '/sign_in?app_identifier=' + TxtVia.appID + '&app_type=chrome'
            },
            logoutLink: function () {
                localStorage.authToken = "";
                localStorage.clientId = 0;
                chrome.tabs.create({
                    url: TxtVia.url + '/sign_out'
                });
                window.close();
            },
            download: function (app) {
                switch (app) {
                case 'android':
                    chrome.tabs.create({
                        url: TxtVia.url + '/downloads/android'
                    });
                    break;
                case 'iphone':
                    alert("Not available yet, please keep upto date on twitter @txtvia");
                    break;
                case 'blackberry':
                    alert("Not available yet, please keep upto date on twitter @txtvia");
                    break;
                }
            },
            syncLink: function () {
                chrome.extension.sendRequest({
                    sync: true
                }, function () {
                    console.log("[Background.Process.fullDownload] comeplete");
                });
            },
            updateGoogleToken: function () {
                chrome.extension.sendRequest({
                    googleToken: true
                }, function (token) {
                    $("img.avatar").each(function () {
                        var url = $(this).data('photo_url');
                        console.log(url);
                        if(url){
                            $(this).fadeOut(function () {
                                $(this).attr('src', url + "?access_token=" + token);
                                $(this).bind('load',function(){
                                   $(this).fadeIn(); 
                                });
                            });
                        }
                    });
                });
            },
            donateLink: function () {
                chrome.tabs.create({
                    url: 'http://txtvia.com/donate_now'
                });
            },
            backToThreads: function () {
                $("body").removeClass("thread").addClass("threads");
            },
            gotToThread: function (empty) {
                if (empty) {
                    $(".thread ol").empty();
                    var input = $("<input>", {
                        type: "tel",
                        required: true,
                        placeholder: "Mobile Phone Number"
                    });
                    input.bind('keyup', function () {
                        $("form input[name=recipient]").val(this.value);
                    });
                    $("form input[name=recipient]").val("");
                    $(".thread header hgroup").empty().html(input);
                }
                $("body").removeClass("threads").addClass("thread");
                $(".thread .scroll").animate({
                    scrollTop: $(".thread .scroll").height()
                });
            },
            lock: function () {
                $("body").removeClass("unlocked").addClass("locked");
            },
            unlock: function () {
                $("body").removeClass("locked").addClass("unlocked");
            }
        },
        UI: {
            displayContact: function (contact) {
                var img = $("<img>", {
                    src: 'images/user_profile_image_30.png'
                }),
                    header = $("<h3>", {
                    text: contact.label
                });

                $(".thread header hgroup").empty().append(img).append(header);
            },
            alert: function () {
                alert("MESSAGE< MESSAGE< MESSAGE");
            },
            flash: function (state, message) {
                function show() {
                    $(".flash").removeClass('red yellow green');
                    switch (state) {
                    case 'red':
                        $(".flash").addClass('red');
                        break;
                    case 'yellow':
                        $(".flash").addClass('yellow');
                        break;
                    case 'green':
                        $(".flash").addClass('green');
                        break;
                    }
                    $(".flash").html(message).slideDown().click(function () {
                        $(this).slideUp();
                    });

                }
                if ($(".flash").is(':visible')) {
                    $(".flash").slideUp(function () {
                        show();
                    });
                } else {
                    show();
                }
            },
            deviceList: function () {
                console.log("Rendering Device List");
                $("select[name=device]").empty();
                TxtVia.WebDB.getDevices(function (t, r) {
                    var i, device;
                    for (i = 0; i < r.rows.length; i++) {
                        device = r.rows.item(i);
                        $("body").removeClass("firstLaunch steps").addClass("main");
                        if (device.device_type !== "client") {
                            $("select[name=device]").append($("<option>", {
                                text: device.name,
                                value: device.id
                            }));
                        }
                    }
                });
            }
        }
    };
}());
PopUp.init();

