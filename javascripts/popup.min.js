var TxtVia={};TxtVia.CHROME="Chrome";TxtVia.SAFARI="Safari";TxtVia.FIREFOX="FireFox";TxtVia.UNKNOWN="Unknown";TxtVia.init=function(){$.support.cors=true;$.ajaxSetup({cache:false,async:true,crossDomain:true,dataType:"json",timeout:4000});if(window.chrome){try{TxtVia.appID=chrome.i18n.getMessage("@@extension_id")}catch(a){console.error("[Chrome] Can't determand extension_id")}TxtVia.appName="Google Chrome";TxtVia.appType=TxtVia.CHROME}else{TxtVia.appID="0";TxtVia.appName="Unknown Client";TxtVia.appType=TxtVia.UNKNOWN}TxtVia.Pusher={};TxtVia.BeaconPush={};TxtVia.PushMethod="Pusher";switch(localStorage.env){case"development":TxtVia.url="http://localhost:8080";TxtVia.Pusher.webSocketID="c9351524b47769e60be7";TxtVia.BeaconPush.webSocketID="1adeccce";break;case"staging":TxtVia.url="http://staging.txtvia.com";TxtVia.Pusher.webSocketID="02364a48c5da78fd5244";TxtVia.BeaconPush.webSocketID="1adeccce";break;default:TxtVia.url="http://txtvia.com";TxtVia.Pusher.webSocketID="c0f2d772bdcdd2e04aa3";TxtVia.BeaconPush.webSocketID="1adeccce";break}TxtVia.Storage();TxtVia.WebDB.open();TxtVia.WebDB.createTables();if(TxtVia.uriParams("auth_token")){localStorage.authToken=TxtVia.uriParams("auth_token")}TxtVia.UNIQUE_ID=TxtVia.appType+":"+TxtVia.appID+":"+localStorage.authToken};TxtVia.uriParams=function(a){var b=new RegExp("[\\?&]"+a+"=([^&#]*)").exec(window.location.href);try{return b[1]||0}catch(c){return null}};TxtVia.TextUtil={};TxtVia.TextUtil.mobileNumber=function(c){try{var b=JSON.parse(localStorage.locale).country_calling;return c.replace(/\s/,"").replace(/^0/,b)}catch(a){console.log("[TxtVia.TextUtil.mobileNumber] can't convert number : "+c)}};TxtVia.TextUtil.removeNumber=function(b){try{return b.replace(/\s*?\(.*\)/,"")}catch(a){console.log("[TxtVia.TextUtil.removeNumber] can't remove number : "+b)}};TxtVia.WebDB={};TxtVia.WebDB.db=null;TxtVia.WebDB.open=function(){var a=5*1024*1024;TxtVia.WebDB.db=openDatabase("TxtVia","1.0","Browser based SMS client",a)};TxtVia.WebDB.onError=function(a,b){if(!b.CONSTRAINT_ERR){console.error(b);alert("Awe damn, Something went wrong: "+b.message+"\n\rIt would probly be a good idea contact support. \n\rhttp://txtvia.com/support")}};TxtVia.WebDB.onSuccess=function(a,b){};TxtVia.WebDB.createTables=function(){TxtVia.WebDB.db.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS messages (id INTEGER PRIMARY KEY ASC, message_id INTEGER UNIQUE NOT NULL, device_id INTEGER NOT NULL, client_id INTEGER, recipient TEXT NOT NULL, body TEXT NOT NULL, read INTEGER DEFAULT 0, messaged_at DATEIME NOT NULL, sent_at DATETIME, received_at DATETIME, created_at DATETIME)",[],function(b,c){console.log("[TxtVia.WebDB.createTables] messages created")},TxtVia.WebDB.onError);a.executeSql("CREATE TABLE IF NOT EXISTS devices (id INTEGER PRIMARY KEY ASC, name TEXT, device_type TEXT, unique_id TEXT UNIQUE NOT NULL, carrier TEXT)",[],function(b,c){console.log("[TxtVia.WebDB.createTables] devices created")},TxtVia.WebDB.onError);a.executeSql("CREATE TABLE IF NOT EXISTS contacts (name TEXT, number TEXT UNIQUE NOT NULL, photo_url TEXT)",[],function(b,c){console.log("[TxtVia.WebDB.createTables] contacts created")},TxtVia.WebDB.onError)})};TxtVia.WebDB.purge=function(a){localStorage.clear();TxtVia.WebDB.purgeDB(a)};TxtVia.WebDB.purgeDB=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("DROP TABLE devices",[],function(){console.log("[TxtVia.WebDB.purge] success")},function(c,d){console.error("[TxtVia.WebDB.purge] Failed");console.error(d)});b.executeSql("DROP TABLE messages",[],function(){console.log("[TxtVia.WebDB.purge] success")},function(c,d){console.error("[TxtVia.WebDB.purge] Failed");console.error(d)});b.executeSql("DROP TABLE contacts",[],function(){console.log("[TxtVia.WebDB.purge] success")},function(c,d){console.error("[TxtVia.WebDB.purge] Failed");console.error(d)})});if(a){TxtVia.WebDB.createTables()}};TxtVia.WebDB.insertInto={};TxtVia.WebDB.insertInto.messages=function(a,b){TxtVia.WebDB.db.transaction(function(c){console.log("[TxtVia.WebDB.insertInto.messages] accepted: ");console.log(a);c.executeSql("INSERT INTO messages (recipient, body, message_id, device_id, client_id, messaged_at, sent_at, received_at, created_at) VALUES (?,?,?,?,?,?,?,?,?)",[TxtVia.TextUtil.mobileNumber(a.recipient),a.body,a.id,a.device_id,a.client_id,a.messaged_at,a.sent_at,a.received_at,a.created_at],b,TxtVia.WebDB.onError)})};TxtVia.WebDB.insertInto.devices=function(a,b){TxtVia.WebDB.db.transaction(function(c){c.executeSql("INSERT INTO devices(name, device_type, carrier, unique_id) VALUES (?,?,?,?)",[a.name,a.device_type,a.carrier,a.unique_id],b,TxtVia.WebDB.onError)})};TxtVia.WebDB.insertInto.contacts=function(a,b){TxtVia.WebDB.db.transaction(function(c){c.executeSql("INSERT INTO contacts(name, number, photo_url) VALUES (?,?,?)",[a.name,TxtVia.TextUtil.mobileNumber(a.number),a.photo_url],b,TxtVia.WebDB.onError)})};TxtVia.WebDB.messageRead=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("UPDATE messages SET read = 1 WHERE id = ?",[a],null,TxtVia.WebDB.onError)})};TxtVia.WebDB.lastReceivedMessage=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("SELECT * FROM messages m LEFT JOIN contacts c On c.number = m.recipient ORDER BY id DESC LIMIT 1",[],a,TxtVia.WebDB.onError)})};TxtVia.WebDB.deletePendingMessage=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("DELETE FROM pending_messages WHERE id = ?",[a],null,TxtVia.WebDB.onError)})};TxtVia.WebDB.getConversations=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("SELECT * FROM messages m LEFT JOIN contacts c ON c.number = m.recipient GROUP BY m.recipient ORDER BY m.created_at DESC",[],function(c,d){var e;for(e=0;e<d.rows.length;e++){a(d.rows.item(e))}},TxtVia.WebDB.onError)})};TxtVia.WebDB.getContacts=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("SELECT * FROM contacts ORDER BY name DESC",[],function(c,d){var e,g=[],f;for(e=0;e<d.rows.length;e++){f={label:d.rows.item(e).name,value:d.rows.item(e).number,photo_url:d.rows.item(e).photo_url};g.push(f)}a(g)},TxtVia.WebDB.onError)})};TxtVia.WebDB.getMessages=function(a,b){TxtVia.WebDB.db.transaction(function(c){c.executeSql("SELECT * FROM `messages` m LEFT JOIN contacts c ON c.number = m.recipient WHERE m.`recipient` = ? ORDER BY `messaged_at` ASC",[a],b,TxtVia.WebDB.onError)})};TxtVia.WebDB.getMessagesCount=function(a,b){TxtVia.WebDB.db.transaction(function(c){c.executeSql("SELECT count(*) c FROM `messages` WHERE `recipient` = ?",[a],function(e,d){b(d.rows.item(0).c)},TxtVia.WebDB.onError)})};TxtVia.WebDB.getContact=function(a,b){TxtVia.WebDB.db.transaction(function(c){c.executeSql("SELECT * FROM `contacts` WHERE number = ? LIMIT 1",[a],b,TxtVia.WebDB.onError)})};TxtVia.WebDB.getDevices=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("SELECT * FROM devices ORDER BY `name` ASC",[],a,TxtVia.WebDB.onError)})};TxtVia.WebDB.unReadMessageCount=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("SELECT COUNT(*) c FROM messages WHERE read = 0",[],a,TxtVia.WebDB.onError)})};TxtVia.WebDB.v112Fix=function(a){TxtVia.WebDB.db.transaction(function(b){b.executeSql("UPDATE messages SET messaged_at = created_at WHERE messaged_at = 'undefined'",[],a,TxtVia.WebDB.onError)})};TxtVia.Storage=function(){if(!localStorage.env){localStorage.env="production"}if(!localStorage.version){localStorage.version="1.0.3"}if(!localStorage.unReadMessages){localStorage.unReadMessages=0}if(!localStorage.firstLaunch){localStorage.firstLaunch=true}if(!localStorage.authToken){localStorage.authToken=""}if(!localStorage.googleToken){localStorage.googleToken=""}if(!localStorage.clientId){localStorage.clientId=0}if(!localStorage.pendingMessages){localStorage.pendingMessages=JSON.stringify([])}if(!localStorage.autoHideNotifications){localStorage.autoHideNotifications=true}if(!localStorage.enableSounds){localStorage.enableSounds=true}if(!localStorage.newMessageSound){localStorage.newMessageSound="newMessage.mp3"}if(!localStorage.locale){localStorage.locale=JSON.stringify({country_code:"GB",country_calling:"+44"})}};var PopUp=(function(){return{init:function(){TxtVia.init();PopUp.Check.firstLaunch(function(){PopUp.Check.authToken(function(){PopUp.Check.client(function(){PopUp.Check.devices()})})});PopUp.RegisterEvents.submitForm();PopUp.RegisterEvents.display();PopUp.RegisterEvents.validateForm();$("form#security").submit(function(b){b.preventDefault()});$("input[type=search]").focus(function(){$(this).val("")});$("input[type=password][name=pincode]").bind("keyup",function(b){if(parseInt($(this).val(),10)===1234){$(this).val("");PopUp.Actions.unlock()}});try{chrome.extension.onRequest.addListener(function(c,b,d){if(c.message){if(PopUp.currentThread===TxtVia.TextUtil.mobileNumber(c.message.recipient)){PopUp.Process.threadConversation(c.message.recipient)}PopUp.Process.threads()}else{console.log(c)}})}catch(a){console.error("[Background.init] onRequest listener failed")}},onReady:function(){console.log("[PopUp] Loaded...");$("body").addClass("loaded")},Check:{tries:0,firstLaunch:function(c){if($.parseJSON(localStorage.firstLaunch)===true){localStorage.firstLaunch=false;console.log("[PopUp.Init] First Launch");$("body").addClass("firstLaunch").removeClass("unlocked main steps");try{setTimeout(c,2000)}catch(b){}PopUp.onReady()}else{console.log("[PopUp.Init] Normal Launch");$("body").removeClass("firstLaunch");try{c()}catch(a){}}},authToken:function(b){if(localStorage.authToken===""){console.log("[PopUp.Init] No Auth Token");$("body").removeClass("main unlocked").addClass("locked").addClass("steps");PopUp.onReady()}else{console.log("[PopUp.Init] Auth Token");$("body").addClass("unlocked").removeClass("locked");try{b()}catch(a){}}},client:function(b){if($.parseJSON(localStorage.clientId)===0){console.log("[PopUp.Init] Client not registered");chrome.extension.sendRequest({client:true},function(){PopUp.Check.client()});$("body").removeClass("main");$(".steps ol li:eq(0)").removeClass("done");PopUp.onReady()}else{console.log("[PopUp.Init] Client registered");$(".steps ol li:eq(0)").addClass("done");try{b()}catch(a){}}},devices:function(){if(PopUp.Check.tries<5){TxtVia.WebDB.getDevices(function(a,b){if(b.rows.length===0){PopUp.Check.tried=PopUp.Check.tried+1;console.log("[PopUp.Init] No devices");chrome.extension.sendRequest({sync:true},function(){PopUp.Check.devices()});$("body").removeClass("main").addClass("steps")}else{console.log("[PopUp.Init] "+b.rows.length+" devices registered");PopUp.Process.view();$("body").addClass("main").removeClass("steps");$(".steps ol li:eq(0)").addClass("done")}PopUp.onReady()})}else{console.log("[PopUp.Check.devices] exceeded max tries.")}}},Process:{view:function(){console.log("Rendering View");PopUp.UI.deviceList();PopUp.Process.threads();PopUp.Process.contacts();$("form").removeClass("loading")},contacts:function(){TxtVia.WebDB.getContacts(function(a){$("input[type=search]").autocomplete({source:a,select:function(d,c){var b={recipient:c.item.value,name:c.item.label,photo_url:c.item.photo_url};d.preventDefault();$("body").removeClass("threads").addClass("thread");$("input[type=search]").val(c.item.label).blur();$("form#new_message textarea").focus();$("form input[name=recipient]").val(c.item.value);PopUp.Process.thread(b,c.item.value)}})})},threads:function(){console.log("Rendering Threads");$("#threads ul li:not(.new_message)").remove();TxtVia.WebDB.getConversations(function(f){var a,d,c,b,g,e;a=$("<li>",{"class":"clearfix"});d=f.photo_url?f.photo_url+"?access_token="+localStorage.googleToken:chrome.extension.getURL("/images/user_profile_image50.png");c=$("<img>",{"class":"avatar",src:d}).hide().data("photo_url",f.photo_url);b=$("<h3>",{html:(f.name?TxtVia.TextUtil.removeNumber(f.name):f.recipient)});g=$("<p>",{text:f.body});c.error(function(){var h=$(this);PopUp.Actions.updateGoogleToken();h.attr("src",chrome.extension.getURL("/images/user_profile_image50.png"))}).bind("load",function(){$(this).fadeIn()});TxtVia.WebDB.getMessagesCount(f.recipient,function(h){b.append(" ");b.append($("<abbr>",{text:"("+h+")",title:h+" messages between you and "+TxtVia.TextUtil.removeNumber(f.name)}))});a.append(c).append(b).append(g);a.bind("click",function(){console.log("Opening Thread "+f.recipient);PopUp.Process.thread(f,PopUp.Actions.gotToThread)});$("#threads ul").append(a)})},thread:function(c,f){console.log(c);PopUp.currentThread=c.recipient;var e=$("<h3>",{text:c.name?c.name:c.recipient}),b=c.photo_url?c.photo_url+"?access_token="+localStorage.googleToken:chrome.extension.getURL("/images/user_profile_image30.png"),a=$("<img>",{"class":"avatar",src:b}).hide().data("photo_url",c.photo_url);try{a.bind("load",function(){$(this).fadeIn()}).error(function(){PopUp.Actions.updateGoogleToken();$(this).attr("src",chrome.extension.getURL("/images/user_profile_image30.png"))})}catch(d){console.log("[PopUp.Process.thread] can't load image")}$(".thread header hgroup").empty().append(a).append(e);$("form input[name=recipient]").val(c.recipient);PopUp.Process.threadConversation(c.recipient);if(f){f()}},threadConversation:function(a){$(".thread ol").empty();TxtVia.WebDB.getMessages(a,function(d,f){var c,b,e,g;for(c=0;c<f.rows.length;c=c+1){e=f.rows.item(c);b=$("<li>",{"class":e.sent_at?"sent":"received",html:e.body+"&nbsp;"});g=$("<time>",{datetime:$.timeago(e.messaged_at),html:$.timeago(e.messaged_at)});TxtVia.WebDB.messageRead(e.id);b.append(g);g.timeago();$(".thread ol").append(b)}$(".thread .scroll").animate({scrollTop:$(".thread .scroll .messages").height()});chrome.extension.sendRequest({updateBadge:true},function(){console.log("[Background.Process.threadConversation] comeplete")})})}},RegisterEvents:{display:function(){var c=$("<a>",{href:"#","class":"login",text:"Login",click:function(){PopUp.Actions.loginLink()}}),a=$("<a>",{href:"#","class":"logout",text:"Logout",click:function(){PopUp.Actions.logoutLink()}}),d=$("<hr>"),e=$("<a>",{href:"#","class":"sync",text:"Sync",click:function(){PopUp.Actions.syncLink()}}),b=$("<a>",{href:"http://txtvia.com/donate_now","class":"donate",text:"Donate",click:function(){PopUp.Actions.donateLink()}});$("header nav").empty().append(e).append(b).append(d);if(localStorage.authToken!==""){$("header nav").append(a)}else{$("header nav").append(c)}$("a.showSettings").bind("click",function(){$(".settings:not(:visible)").fadeIn()});$(".settings a").click(function(){$(".settings:visible").fadeOut()});$(".settings").bind("mouseleave",function(){if(window.settingTimeout){clearTimeout(window.settingTimeout)}window.settingTimeout=setTimeout(function(){$(".settings:visible").fadeOut()},3000)})},validateForm:function(){$("textarea").bind("keyup",function(){if($(this).val()===""){$("form#new_message").find("input[type=submit]").attr("disabled","disabled")}else{$("form#new_message").find("input[type=submit]").removeAttr("disabled")}})},submitForm:function(){$("form#new_message textarea").keydown(function(a){if((a.ctrlKey||a.metaKey)&&a.keyCode===13){$("form#new_message").trigger("submit")}});$("form#new_message").bind("submit",function(c){var j=$(this),f,h,g,b,d,a,i;if($("form#new_message textarea").val().length>0){$("form#new_message").addClass("loading");$(":input[name=device_id]").val($(":input[name=device]").val());f=$.parseJSON(localStorage.pendingMessages);i={data:$(this).serialize()};g=$("<p>",{text:$(this).find(":input[name='body']").val()});b=$("<header>",{text:$(this).find(":input[name='recipient']").val()});d=$("<article>").append(b).append(g);$("#sent .messages").append(d);h=$("<li>",{"class":"sent sending",html:j.find("textarea").val()+"&nbsp;"});a=$("<time>",{html:"sending&hellip;"});h.append(a);$(".thread ol").append(h);$(".thread .scroll").animate({scrollTop:$(".thread .scroll ol").height()});f.push(i);localStorage.pendingMessages=JSON.stringify(f);$(this).find("textarea").val("")}c.preventDefault()})}},Actions:{loginLink:function(){if(chrome.tabs){chrome.tabs.create({url:TxtVia.url+"/sign_in?return_url="+encodeURIComponent(chrome.extension.getURL("/popup.html"))})}else{window.open(TxtVia.url+"/sign_in?return_url="+window.location.href)}window.close()},logoutLink:function(){localStorage.authToken="";localStorage.clientId=0;localStorage.googleToken="";localStorage.unReadMessages=0;TxtVia.WebDB.purgeDB(true);chrome.tabs.create({url:TxtVia.url+"/sign_out"});window.close()},download:function(a){switch(a){case"android":chrome.tabs.create({url:TxtVia.url+"/downloads/android"});break;case"iphone":alert("Not available yet, please keep upto date on twitter @txtvia");break;case"blackberry":alert("Not available yet, please keep upto date on twitter @txtvia");break}},syncLink:function(){chrome.extension.sendRequest({sync:true},function(){PopUp.Process.view();console.log("[Background.Process.fullDownload] comeplete")})},updateGoogleToken:function(){chrome.extension.sendRequest({googleToken:true},function(a){$("img.avatar").each(function(){var b=$(this).data("photo_url");if(b){$(this).fadeOut(function(){$(this).attr("src",b+"?access_token="+a);$(this).bind("load",function(){$(this).fadeIn()})})}})})},donateLink:function(){chrome.tabs.create({url:"http://txtvia.com/donate_now"})},backToThreads:function(){$("body").removeClass("thread").addClass("threads")},gotToThread:function(b){if(b){$(".thread ol").empty();var a=$("<input>",{type:"tel",required:true,placeholder:"Mobile Phone Number"});a.bind("keyup",function(){$("form input[name=recipient]").val(this.value)});$("form input[name=recipient]").val("");$(".thread header hgroup").empty().html(a)}$("body").removeClass("threads").addClass("thread");$(".thread .scroll").animate({scrollTop:$(".thread .scroll").height()})},lock:function(){$("body").removeClass("unlocked").addClass("locked")},unlock:function(){$("body").removeClass("locked").addClass("unlocked")}},UI:{displayContact:function(a){var b=$("<img>",{src:"images/user_profile_image_30.png"}),c=$("<h3>",{text:a.label});$(".thread header hgroup").empty().append(b).append(c)},alert:function(){alert("MESSAGE< MESSAGE< MESSAGE")},flash:function(c,b){function a(){$(".flash").removeClass("red yellow green");switch(c){case"red":$(".flash").addClass("red");break;case"yellow":$(".flash").addClass("yellow");break;case"green":$(".flash").addClass("green");break}$(".flash").html(b).slideDown().click(function(){$(this).slideUp()})}if($(".flash").is(":visible")){$(".flash").slideUp(function(){a()})}else{a()}},deviceList:function(){console.log("Rendering Device List");$("select[name=device]").empty();TxtVia.WebDB.getDevices(function(b,d){var a,c;for(a=0;a<d.rows.length;a=a+1){c=d.rows.item(a);$("body").removeClass("firstLaunch steps").addClass("main");if(c.device_type!=="client"){$("select[name=device]").append($("<option>",{text:c.name,value:c.id}))}}})}}}}());PopUp.init();